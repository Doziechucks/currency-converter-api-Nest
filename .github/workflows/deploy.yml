name: Deploy to Server

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: vars
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 159.138.145.20
          username: chiedozie
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 30m
          script: |
            set -e

            VERSION=${{ steps.vars.outputs.version }}
            RELEASE_DIR=/home/chiedozie/releases/v$VERSION
            CURRENT_DIR=/home/chiedozie/current
            TMP_DIR=/home/chiedozie/tmp_deploy

            rm -rf $TMP_DIR
            mkdir -p $TMP_DIR
            mkdir -p /home/chiedozie/releases

            rsync -av --delete \
              --exclude='node_modules' \
              --exclude='.git' \
              --exclude='dist' \
              --exclude='.env' \
              ./ $TMP_DIR/

            rm -rf $RELEASE_DIR
            mv $TMP_DIR $RELEASE_DIR

            cd $RELEASE_DIR
            npm ci --prefer-offline --production=false
            npm run build
            npm prune --production

            ln -sfn $RELEASE_DIR $CURRENT_DIR
            cd $CURRENT_DIR

            if pm2 describe currency-api > /dev/null 2>&1; then
              pm2 delete currency-api
            fi

            pm2 start ecosystem.config.js
            pm2 save

            sleep 5

            if ! pm2 describe currency-api | grep -q "online"; then
              pm2 logs currency-api --lines 50 --nostream --err
              exit 1
            fi

      - name: Verify deployment health
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 159.138.145.20
          username: chiedozie
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            sleep 3
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/api/health)

            if [ "$STATUS" != "200" ]; then
              exit 1
            fi

      - name: Cleanup old releases
        if: success()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 159.138.145.20
          username: chiedozie
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            cd /home/chiedozie/releases
            ls -t | tail -n +4 | xargs -r rm -rf
