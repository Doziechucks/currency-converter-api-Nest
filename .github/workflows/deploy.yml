name: Deploy to Server

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for proper tag checkout

      - name: Extract version from tag
        id: vars
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 159.138.145.20
          username: chiedozie
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 40m
          script: |
            set -e  # Exit on any error

            VERSION=${{ steps.vars.outputs.version }}
            REPO_URL="https://github.com/${{ github.repository }}.git"
            RELEASE_DIR=/home/chiedozie/releases/v$VERSION
            CURRENT_DIR=/home/chiedozie/current

            echo "=================================="
            echo "Deploying version v$VERSION"
            echo "=================================="

            # Create releases directory if it doesn't exist
            mkdir -p /home/chiedozie/releases

            # Remove old release directory if it exists (clean start for this version)
            rm -rf $RELEASE_DIR

            # Clone the specific tag into the versioned release folder
            git clone --depth 1 --branch v$VERSION $REPO_URL $RELEASE_DIR

            # Enter the new release
            cd $RELEASE_DIR

            # Reuse node_modules from current version if available (saves time & disk)
            if [ -d "$CURRENT_DIR/node_modules" ]; then
              echo "Copying existing node_modules from current release"
              cp -a $CURRENT_DIR/node_modules .
            fi

            # Install dependencies only if needed
            if [ ! -d "node_modules" ] || ! npm ci --prefer-offline --production=false --dry-run > /dev/null 2>&1; then
              echo "Installing/updating dependencies"
              npm ci --prefer-offline --production=false
            else
              echo "node_modules is up to date – skipping install"
            fi

            # Build the application
            echo "Building application..."
            npm run build

            # Verify build output exists
            if [ ! -f "dist/main.js" ]; then
              echo "ERROR: Build failed – dist/main.js not found!"
              find dist -type f || echo "dist folder empty or missing"
              exit 1
            fi

            # Remove dev dependencies for production
            npm prune --production

            # Update the current symlink to point to the new release
            ln -sfn $RELEASE_DIR $CURRENT_DIR
            echo "Symlink updated: ~/current → v$VERSION"

            # === PM2 Restart (zero-downtime when possible) ===
            cd $CURRENT_DIR

            echo "Reloading/restarting PM2 process..."
            if pm2 describe currency-api > /dev/null 2>&1; then
              pm2 reload ecosystem.config.js --update-env
            else
              pm2 start ecosystem.config.js
            fi

            pm2 save

            # Wait and verify process is online
            sleep 8
            if pm2 describe currency-api | grep -q "online"; then
              echo "Deployment successful – currency-api is online"
              pm2 status
            else
              echo "Deployment failed – process not online"
              pm2 logs currency-api --lines 50 --err
              exit 1
            fi

      - name: Verify health endpoint
        if: success()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 159.138.145.20
          username: chiedozie
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            sleep 5
            echo "Checking health endpoint..."
            if curl -f http://localhost:3000/api/health; then
              echo "Health check passed"
            else
              echo "Health check failed"
              pm2 logs currency-api --lines 30 --err
              exit 1
            fi

      - name: Cleanup old releases
        if: success()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 159.138.145.20
          username: chiedozie
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "Cleaning up old releases (keeping the latest 3)"
            cd /home/chiedozie/releases
            ls -t | tail -n +4 | xargs -r rm -rf
            echo "Cleanup complete"
