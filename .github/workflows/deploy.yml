name: Deploy to Server
on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: vars
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 159.138.145.20
          username: chiedozie
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 30m
          script: |
            set -e
            VERSION=${{ steps.vars.outputs.version }}
            REPO_URL="https://github.com/${{ github.repository }}.git"
            RELEASE_DIR=/home/chiedozie/releases/v$VERSION
            CURRENT_DIR=/home/chiedozie/current
            ECOSYSTEM_FILE=/home/chiedozie/ecosystem.config.js  # â† Fixed path

            echo "Deploying version v$VERSION"

            mkdir -p /home/chiedozie/releases
            git clone --depth 1 --branch v$VERSION $REPO_URL $RELEASE_DIR
            cd $RELEASE_DIR

            # Copy node_modules from current if exists
            if [ -d "$CURRENT_DIR/node_modules" ]; then
              echo "Copying existing node_modules"
              cp -r $CURRENT_DIR/node_modules .
            fi

            # Install only if needed
            if [ ! -d "node_modules" ] || ! npm ci --prefer-offline --production=false --dry-run > /dev/null 2>&1; then
              echo "Installing dependencies"
              npm ci --prefer-offline --production=false
            else
              echo "Dependencies up to date"
            fi

            npm run build

            npm prune --production

            # Update symlink
            ln -sfn $RELEASE_DIR $CURRENT_DIR

            # Copy/update fixed ecosystem file (in case of config changes)
            cp $CURRENT_DIR/ecosystem.config.js $ECOSYSTEM_FILE  # If you keep a copy in repo

            # Restart PM2 with zero-downtime reload
            cd /home/chiedozie  # Run from fixed location
            if pm2 describe currency-api > /dev/null 2>&1; then
              pm2 reload $ECOSYSTEM_FILE --update-env
            else
              pm2 start $ECOSYSTEM_FILE
            fi
            pm2 save

            # Verify
            sleep 5
            if pm2 describe currency-api | grep -q "online"; then
              echo "Deployment successful"
            else
              echo "Deployment failed"
              pm2 logs currency-api --lines 50
              exit 1
            fi

      - name: Verify health endpoint
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 159.138.145.20
          username: chiedozie
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            sleep 5
            curl -f http://localhost:3000/api/health || (pm2 logs currency-api --lines 50 && exit 1)
            echo "Health check passed"

      - name: Cleanup old releases
        if: success()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 159.138.145.20
          username: chiedozie
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            cd /home/chiedozie/releases
            ls -t | tail -n +4 | xargs -r rm -rf
            echo "Cleaned up old releases (kept last 3)"
